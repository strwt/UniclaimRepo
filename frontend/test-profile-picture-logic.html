<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Picture Logic Test</title>
</head>

<body>
    <h1>Profile Picture Logic Test</h1>
    <p>Open the browser console and run the test functions below:</p>

    <h2>Test Functions:</h2>
    <ul>
        <li><code>testIsCloudinaryImage()</code> - Test URL validation</li>
        <li><code>testExtractPublicId()</code> - Test public ID extraction</li>
        <li><code>testProfilePictureFlow()</code> - Test the complete flow logic</li>
    </ul>

    <script>
        // Test function to check if a URL is a Cloudinary image
        function testIsCloudinaryImage() {
            console.log('ðŸ§ª Testing isCloudinaryImage function...');

            const testUrls = [
                'https://res.cloudinary.com/demo/image/upload/v1234567890/profiles/test_user.jpg',
                'https://res.cloudinary.com/demo/image/upload/profiles/another_user.png',
                'https://api.cloudinary.com/v1_1/demo/image/upload/profiles/user123.jpg',
                'https://example.com/image.jpg',
                'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...',
                '',
                null,
                'https://res.cloudinary.com/demo/image/upload/',
                'https://res.cloudinary.com/demo/image/upload/v123/profiles/'
            ];

            testUrls.forEach((url, index) => {
                const result = isCloudinaryImage(url);
                console.log(`Test ${index + 1}: "${url}" -> ${result ? 'âœ… Valid' : 'âŒ Invalid'}`);
            });
        }

        // Test function to extract Cloudinary public ID
        function testExtractPublicId() {
            console.log('ðŸ§ª Testing extractCloudinaryPublicId function...');

            const testUrls = [
                'https://res.cloudinary.com/demo/image/upload/v1234567890/profiles/test_user.jpg',
                'https://res.cloudinary.com/demo/image/upload/profiles/another_user.png',
                'https://api.cloudinary.com/v1_1/demo/image/upload/profiles/user123.jpg',
                'https://example.com/image.jpg'
            ];

            testUrls.forEach((url, index) => {
                const publicId = extractCloudinaryPublicId(url);
                console.log(`Test ${index + 1}: "${url}" -> Public ID: "${publicId}"`);
            });
        }

        // Test the complete profile picture flow logic
        function testProfilePictureFlow() {
            console.log('ðŸ§ª Testing complete profile picture flow logic...');

            // Simulate the flow
            const oldProfilePicture = 'https://res.cloudinary.com/demo/image/upload/v1234567890/profiles/old_user.jpg';
            const newProfilePicture = 'https://res.cloudinary.com/demo/image/upload/v987654321/profiles/new_user.jpg';
            const defaultImage = 'https://example.com/default.jpg';
            const emptyString = '';

            console.log('ðŸ“‹ Test Cases:');
            console.log('1. Old: Cloudinary, New: Cloudinary (should delete old)');
            console.log('2. Old: Default, New: Cloudinary (should not delete old)');
            console.log('3. Old: Empty, New: Cloudinary (should not delete old)');
            console.log('4. Old: Same as new (should not delete old)');

            // Test case 1: Cloudinary to Cloudinary
            console.log('\nâœ… Test Case 1: Cloudinary to Cloudinary');
            if (oldProfilePicture && oldProfilePicture !== "" && oldProfilePicture !== newProfilePicture) {
                if (isCloudinaryImage(oldProfilePicture)) {
                    console.log('   -> Old image is Cloudinary, will delete');
                } else {
                    console.log('   -> Old image is not Cloudinary, skipping deletion');
                }
            } else {
                console.log('   -> No old image or same as new, skipping deletion');
            }

            // Test case 2: Default to Cloudinary
            console.log('\nâœ… Test Case 2: Default to Cloudinary');
            if (defaultImage && defaultImage !== "" && defaultImage !== newProfilePicture) {
                if (isCloudinaryImage(defaultImage)) {
                    console.log('   -> Old image is Cloudinary, will delete');
                } else {
                    console.log('   -> Old image is not Cloudinary, skipping deletion');
                }
            } else {
                console.log('   -> No old image or same as new, skipping deletion');
            }

            // Test case 3: Empty to Cloudinary
            console.log('\nâœ… Test Case 3: Empty to Cloudinary');
            if (emptyString && emptyString !== "" && emptyString !== newProfilePicture) {
                if (isCloudinaryImage(emptyString)) {
                    console.log('   -> Old image is Cloudinary, will delete');
                } else {
                    console.log('   -> Old image is not Cloudinary, skipping deletion');
                }
            } else {
                console.log('   -> No old image or same as new, skipping deletion');
            }

            // Test case 4: Same image
            console.log('\nâœ… Test Case 4: Same image');
            if (newProfilePicture && newProfilePicture !== "" && newProfilePicture !== newProfilePicture) {
                if (isCloudinaryImage(newProfilePicture)) {
                    console.log('   -> Old image is Cloudinary, will delete');
                } else {
                    console.log('   -> Old image is not Cloudinary, skipping deletion');
                }
            } else {
                console.log('   -> No old image or same as new, skipping deletion');
            }
        }

        // Simplified versions of our utility functions for testing
        function isCloudinaryImage(url) {
            if (!url || typeof url !== 'string') return false;

            const isCloudinaryUrl = url.includes('cloudinary.com');
            const hasValidPublicId = extractCloudinaryPublicId(url) !== null;

            return isCloudinaryUrl && hasValidPublicId;
        }

        function extractCloudinaryPublicId(url) {
            try {
                if (url.includes('res.cloudinary.com')) {
                    const urlParts = url.split('/');
                    const uploadIndex = urlParts.findIndex(part => part === 'upload');

                    if (uploadIndex === -1) return null;

                    let publicIdParts = urlParts.slice(uploadIndex + 1);

                    const versionIndex = publicIdParts.findIndex(part => /^v\d+$/.test(part));
                    if (versionIndex !== -1) {
                        publicIdParts = publicIdParts.slice(versionIndex + 1);
                    }

                    if (publicIdParts.length > 0) {
                        const lastPart = publicIdParts[publicIdParts.length - 1];
                        const extensionIndex = lastPart.lastIndexOf('.');
                        if (extensionIndex !== -1) {
                            publicIdParts[publicIdParts.length - 1] = lastPart.substring(0, extensionIndex);
                        }
                    }

                    const publicId = publicIdParts.join('/');
                    return publicId;
                } else if (url.includes('api.cloudinary.com')) {
                    const urlParts = url.split('/');
                    const uploadIndex = urlParts.findIndex(part => part === 'upload');

                    if (uploadIndex === -1) return null;

                    const publicIdParts = urlParts.slice(uploadIndex + 1);
                    const publicId = publicIdParts.join('/');
                    return publicId;
                }

                return null;
            } catch (error) {
                console.error('Error extracting Cloudinary public ID:', error);
                return null;
            }
        }

        console.log('ðŸš€ Profile Picture Logic Test loaded!');
        console.log('Run testIsCloudinaryImage(), testExtractPublicId(), or testProfilePictureFlow() to test the logic.');
    </script>
</body>

</html>